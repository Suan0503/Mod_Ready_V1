{% extends "base.html" %}
{% block title %}白名單管理{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4">白名單</h1>
  <div>
    <a href="{{ url_for('admin.whitelist_add') }}" class="btn btn-primary">新增白名單</a>
    <a href="{{ export_url if export_url else url_for('admin.export_whitelist') }}" class="btn btn-outline-secondary">匯出 CSV</a>
  </div>
</div>

<div class="table-wrap">
  <table class="table table-striped table-bordered align-middle">
    <thead class="table-light">
      <tr>
        <th>#</th>
        <th>建立時間</th>
        <th>日期</th>
        <th>姓名</th>
        <th>電話</th>
        <th>LINE ID</th>
        <th>LINE User ID</th>
        <th>備註 / 理由</th>
        <th>動作</th>
      </tr>
    </thead>
    <tbody>
      {% if users %}
        {% for u in users %}
        <tr>
          <td>{{ u.id }}</td>
          <td>{{ u.created_at.strftime('%Y-%m-%d %H:%M') if u.created_at else '' }}</td>
          <td>{{ u.date or '' }}</td>
          <td>{{ u.name or '' }}</td>
          <td>{{ u.phone or '' }}</td>
          <td>{{ u.line_id or '' }}</td>
          <td>{{ u.line_user_id or '' }}</td>
          <td style="max-width:300px; white-space:pre-wrap;">{{ u.reason or '' }}</td>
          <td>
            <a class="btn btn-sm btn-outline-primary mb-1" href="{{ url_for('admin.whitelist_view', id=u.id) }}">檢視</a>
            <a class="btn btn-sm btn-outline-secondary mb-1" href="{{ url_for('admin.whitelist_edit', id=u.id) }}">編輯</a>

            <form method="post" action="{{ url_for('admin.move_to_blacklist', id=u.id) }}" style="display:inline;" onsubmit="return confirm('確定將此使用者移到黑名單？');">
              {{ csrf_field() if csrf_field is defined else '' }}
              <button type="submit" class="btn btn-sm btn-warning mb-1">移至黑名單</button>
            </form>

            <form method="post" action="{{ url_for('admin.whitelist_delete', id=u.id) }}" style="display:inline;" onsubmit="return confirm('確定刪除此白名單？');">
              {{ csrf_field() if csrf_field is defined else '' }}
              <button type="submit" class="btn btn-sm btn-danger mb-1">刪除</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="9" class="text-center">目前沒有記錄</td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>

<!-- 分頁 -->
{% if total_pages is defined and total_pages|int > 1 %}
<nav aria-label="Page navigation">
  <ul class="pagination">
    <li class="page-item {% if page|int <= 1 %}disabled{% endif %}">
      <a class="page-link" href="?q={{ request.args.get('q','') }}&page={{ page|int -1 }}">上一頁</a>
    </li>
    {% for p in range(1, total_pages|int + 1) %}
      <li class="page-item {% if p == page|int %}active{% endif %}">
        <a class="page-link" href="?q={{ request.args.get('q','') }}&page={{ p }}">{{ p }}</a>
      </li>
    {% endfor %}
    <li class="page-item {% if page|int >= total_pages|int %}disabled{% endif %}">
      <a class="page-link" href="?q={{ request.args.get('q','') }}&page={{ page|int +1 }}">下一頁</a>
    </li>
  </ul>
</nav>
{% endif %}
{% endblock %}
